# Make-booster

This project (contained in this directory and below)
provides utility routines intended to simplify data processing
using GNU make and Python.
In particular, it helps reliably *reproduce* results
and it automatically determines what needs to run.

In particular:

* If a Python script is modified (including one that is transitively
  included by other Python scripts), or its internal inputs are modified,
  all the processes that depend on that script (or internal inputs) are rerun.
  This dependency calculation of Python scripts is done automatically.
* By default we enable "Delete on Error" to avoid accidentally including
  corrupted data in final results.
* It supports "grouped targets" to correctly handle processes that generate
  multiple files.
* Tests and source code scans will be automatically
  run as appropriate if a Python file is changed.

## Installation

First, `cd` to the directory that contains your main `Makefile`.

Second, download `make-booster` to the `make-booster/` subdirectory, e.g.,
by using:

~~~~sh
git clone
https://github.com/david-a-wheeler/make-booster.git
~~~~

To use it, just add this line to your Makefile:

~~~~
include make-booster/booster.makefile
~~~~

If your source files are `scripts/` you're done; if not, set
`SRC_DIR` to the top level directory for scripts you want monitored for
changes.

In most cases you should also install a Python scanner (`pylint` by default),
shell scanner (`shellcheck` by default), and Python tester
(`pytest` by default).
If you don't like those defaults, set the Make variables
`PYTHON_SCANNER`, `SHELL_SCANNER`, and/or `PYTHON_TESTER` to your
values before including `booster.makefile`.

## Quickstart (how to use this)

### Creating rules with uses

Create Makefile rules as always, where you identify how to generate
some `RESULT` given one or more `INPUT` values and commands to do so.
In addition, for every Python script MYSCRIPT.py that your commands use,
add as an input `$(call uses,scripts/MYSCRIPT.py)`.
This means that many of your rules will look like this:

~~~~
RESULT: \
  INPUT \
  $(call uses,scripts/MYSCRIPT.py)
	$(PYTHON3) scripts/MYSCRIPT.py < $< > $@
~~~~

The call to `uses` will mean that if any file changes that could cause
a change in the result of running `MYSCRIPT.py`, this rule will be re-run.
This dependency calculation of Python scripts is done automatically.

### Delete on Error

By default this enables "Delete on Error" to avoid accidentally including
corrupted data in final results.  That means that if a rule fails,
the corrupted generated file will be deleted. If you want to keep
that file (e.g., for debugging), use `make KEEP_FILES_ON_ERROR=true ...`.

### Grouped targets

If two or more files (say BB and CC) are generated by a single command,
those generated files are called "grouped targets".
A common mistake when using Makefiles is write grouped targets this way:

~~~~Makefile
BB CC: DD EE # WRONG
<TAB>command
~~~~

This is a mistake because this notation
does *not* mean that “both BB and CC are simultaneously created
by running the command”.  Instead, it means, “If BB is out-of-date
with respect to DD and EE, then run command” and *separately*
“If CC is out-of-date with respect to DD and EE, then run command”
(running command twice).

Instead, when you have grouped targets, use the "grouped target" call
implemented by `make-booster`.
You do this by selecting some file name as a "marker" that the
command has been done and writing in this form:

~~~~
$(call grouped_target,BB CC,BBCC.marker)
BBCC.marker: .... # dependencies of process to generate BB and CC
<TAB>command to generate BB and CC
<TAB>touch $@
~~~~

A future version of GNU make will include direct
support for grouped targets using the “&:” syntax like this:

~~~~
BB CC &: DD EE
<TAB>command
~~~~

For more information (including specifics of what it can do and how it works),
see [make-booster.md](make-booster.md).

## License

This software is released under the MIT (expat) license, see
[LICENSE.txt](LICENSE.txt).

The original software is
(C) Copyright 2019 Institute for Defense Analyses (IDA).
Its release as open source software (OSS) was approved on 2019-07-16.
As stated in DFARS 252.227-7014 (Rights in noncommercial computer software
and noncommercial computer software documentation),
the US federal government has unlimited rights in this computer software.
This applies to all of the code included here unless otherwise noted.
Unlimited rights means rights to use, modify, reproduce, release,
perform, display, or disclose computer software or computer software
documentation in whole or in part, in any manner and for any purpose
whatsoever, and to have or authorize others to do so.
